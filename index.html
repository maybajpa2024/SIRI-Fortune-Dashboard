<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Siri Fortune Maintenance Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 15px;
        }

        .connection-status {
            background: rgba(255,255,255,0.1);
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-block;
            margin: 10px 5px;
            font-size: 0.9rem;
        }

        .connection-status.connected {
            background: rgba(46, 204, 113, 0.3);
        }

        .connection-status.disconnected {
            background: rgba(231, 76, 60, 0.3);
        }

        .connection-status.connecting {
            background: rgba(241, 196, 15, 0.3);
        }

        .refresh-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 15px;
            cursor: pointer;
            margin: 5px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .setup-instructions {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin: 20px;
            display: none;
        }

        .setup-instructions.show {
            display: block;
        }

        .month-filter {
            background: #e8f5e8;
            border: 1px solid #27ae60;
            border-radius: 8px;
            padding: 15px;
            margin: 20px;
            text-align: center;
        }

        .month-filter h3 {
            color: #27ae60;
            margin-bottom: 15px;
        }

        .month-selector {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .month-selector select {
            padding: 8px 15px;
            border: 2px solid #27ae60;
            border-radius: 5px;
            background: white;
            font-size: 1rem;
            min-width: 150px;
        }

        .month-selector button {
            background: #27ae60;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
        }

        .month-selector button:hover {
            background: #229954;
        }

        .url-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
        }

        .balance-input {
            width: 150px;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 5px;
            margin: 5px;
            text-align: right;
        }

        .connect-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s ease;
        }

        .connect-btn:hover {
            background: #229954;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            overflow-x: auto;
        }

        .tab {
            padding: 15px 20px;
            background: #e9ecef;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            border-radius: 0;
            white-space: nowrap;
            min-width: 130px;
        }

        .tab.active {
            background: white;
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
        }

        .tab:hover:not(.active) {
            background: #dee2e6;
        }

        .tab-content {
            display: none;
            padding: 30px;
            min-height: 500px;
        }

        .tab-content.active {
            display: block;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 8px 15px rgba(52, 152, 219, 0.3);
            transition: transform 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-card.success {
            background: linear-gradient(135deg, #27ae60, #229954);
            box-shadow: 0 8px 15px rgba(39, 174, 96, 0.3);
        }

        .metric-card.warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            box-shadow: 0 8px 15px rgba(243, 156, 18, 0.3);
        }

        .metric-card.danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            box-shadow: 0 8px 15px rgba(231, 76, 60, 0.3);
        }

        .metric-card.purple {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            box-shadow: 0 8px 15px rgba(155, 89, 182, 0.3);
        }

        .metric-card.info {
            background: linear-gradient(135deg, #3498db, #2980b9);
            box-shadow: 0 8px 15px rgba(52, 152, 219, 0.3);
        }

        .metric-card.dark {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            box-shadow: 0 8px 15px rgba(52, 73, 94, 0.3);
        }

        .metric-value {
            font-size: 2.2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2c3e50;
            text-align: center;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .data-table th {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .data-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .data-table tr:hover {
            background: #e3f2fd;
        }

        .status-paid {
            background: #d4edda;
            color: #155724;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .status-pending {
            background: #f8d7da;
            color: #721c24;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .amount {
            font-weight: 600;
            color: #2c3e50;
        }

        .expense-amount {
            font-weight: 600;
            color: #e74c3c;
        }

        .search-box {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 1rem;
            margin-bottom: 20px;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .search-box:focus {
            border-color: #3498db;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #7f8c8d;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .balance-section {
            background: linear-gradient(135deg, #e8f5e8, #f0f8f0);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            border-left: 4px solid #27ae60;
        }

        .balance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .balance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
        }

        .balance-item label {
            font-weight: 600;
            color: #34495e;
        }

        .financial-summary {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            border-left: 4px solid #3498db;
        }

        .financial-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .financial-row:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .last-updated {
            position: absolute;
            top: 10px;
            right: 20px;
            background: rgba(255,255,255,0.1);
            color: white;
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 0.8rem;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 15px;
            margin: 20px;
        }

        .feature-highlight {
            background: #e3f2fd;
            border: 1px solid #1976d2;
            border-radius: 8px;
            padding: 15px;
            margin: 20px;
        }

        .feature-highlight h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin: 20px;
            flex-wrap: wrap;
        }

        .action-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .action-btn.export {
            background: #9b59b6;
        }

        .action-btn.export:hover {
            background: #8e44ad;
        }

        .action-btn.print {
            background: #f39c12;
        }

        .action-btn.print:hover {
            background: #e67e22;
        }

        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .tab {
                padding: 12px 15px;
                font-size: 0.8rem;
                min-width: 100px;
            }

            .month-selector {
                flex-direction: column;
                gap: 10px;
            }

            .action-buttons {
                justify-content: center;
            }
        }

        @media print {
            .refresh-btn, .connect-btn, .setup-instructions, .month-filter, .tabs, .search-box, .action-buttons {
                display: none !important;
            }
            .dashboard-container {
                box-shadow: none;
                border-radius: 0;
            }
            .chart-container {
                height: 200px !important;
            }
            .tab-content {
                display: block !important;
                page-break-after: always;
            }
            .tab-content:last-child {
                page-break-after: auto;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header Section -->
        <div class="header">
            <h1>🏠 Siri Fortune Maintenance Dashboard</h1>
            <p>Complete Financial Management System with Dynamic Balance Tracking</p>
            <div>
                <div id="connectionStatus" class="connection-status disconnected">
                    📡 Click "Connect" to link your Google Sheets
                </div>
                <button class="refresh-btn" onclick="refreshData()">🔄 Refresh</button>
            </div>
            <div class="last-updated" id="lastUpdated">Never updated</div>
        </div>

        <!-- Error Messages -->
        <div id="errorMessages" style="display: none;"></div>

        <!-- Feature Highlights -->
        <div class="feature-highlight">
            <h4>🚀 Dashboard Features</h4>
            <ul style="margin-left: 20px; color: #555;">
                <li><strong>Real-time Data:</strong> Auto-syncs with Google Sheets every 5 minutes</li>
                <li><strong>Multi-month Analysis:</strong> View data for individual months or all months combined</li>
                <li><strong>Dynamic Balance Tracking:</strong> Automatic opening/closing balance calculations</li>
                <li><strong>Interactive Charts:</strong> Visual analysis of collections, expenses, and balance trends</li>
                <li><strong>Smart Search:</strong> Filter payments and expenses with real-time search</li>
                <li><strong>Export & Print:</strong> Download data or print professional reports</li>
            </ul>
        </div>

        <!-- Month Filter Section -->
        <div class="month-filter">
            <h3>📅 Select Month to View</h3>
            <div class="month-selector">
                <select id="monthSelector">
                    <option value="all">All Months</option>
                </select>
                <button onclick="updateForSelectedMonth()">📊 Update Dashboard</button>
                <span id="availableMonths" style="color: #666; font-size: 0.9rem;">
                    Available: Loading...
                </span>
            </div>
        </div>

        <!-- Setup Instructions (Hidden by default) -->
        <div id="setupInstructions" class="setup-instructions">
            <h3>🔧 Setup Required: Connect Your Google Sheets</h3>
            <p style="margin-bottom: 15px; color: #666;">Follow these steps to connect your Google Sheets and start using the dashboard:</p>
            
            <ol style="margin-bottom: 20px;">
                <li><strong>Sheet 1 (MaintenanceData):</strong> Flat payments with columns: Flat, Mar2025, Apr2025, May2025, Jun2025, Jul2025...</li>
                <li><strong>Sheet 2 (ExpenseData):</strong> Monthly expenses with Month column: Mar2025, Apr2025, May2025, Jun2025...</li>
                <li><strong>Sheet 3 (BalanceData - Optional):</strong> Monthly balances with columns: Month, Opening Balance, Closing Balance</li>
                <li><strong>Make all sheets public:</strong> Share → "Anyone with link can view"</li>
                <li>Dashboard will auto-detect all available months</li>
            </ol>

            <div style="background: #e8f5e8; color: #155724; padding: 15px; border-radius: 8px; margin: 15px 0;">
                <h4>💡 Dynamic Balance Tracking Feature</h4>
                <p><strong>Option 1:</strong> Create a Balance sheet with columns: Month, Opening Balance, Closing Balance</p>
                <p><strong>Option 2:</strong> Leave Balance Sheet ID empty to use manual opening balance (calculated closing balance)</p>
                <div style="margin-top: 10px; font-family: monospace; font-size: 0.9rem; background: white; padding: 10px; border-radius: 5px;">
                    <strong>Balance Sheet Example:</strong><br>
                    Month | Opening Balance | Closing Balance<br>
                    Mar2025 | 50000 | 48000<br>
                    Apr2025 | 48000 | 52000<br>
                    May2025 | 52000 | 49000
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin: 15px 0;">
                <div>
                    <label><strong>Maintenance Sheet ID:</strong></label>
                    <input type="text" id="maintenanceSheetId" class="url-input" placeholder="Maintenance sheet ID" value="" />
                    <small style="color: #666;">Extract from: /d/<strong>SHEET_ID</strong>/edit</small>
                </div>
                <div>
                    <label><strong>Expense Sheet ID (gid):</strong></label>
                    <input type="text" id="expenseSheetId" class="url-input" placeholder="Expense sheet ID (gid)" value="" />
                    <small style="color: #666;">Extract from: #gid=<strong>GID_NUMBER</strong></small>
                </div>
                <div>
                    <label><strong>Balance Sheet ID (gid) - Optional:</strong></label>
                    <input type="text" id="balanceSheetId" class="url-input" placeholder="Balance sheet ID (gid)" value="" />
                    <small style="color: #666;">Leave empty to use manual balance</small>
                </div>
            </div>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0;">
                <h4>💰 Fallback Opening Balance (used when Balance Sheet not provided)</h4>
                <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
                    <label>Opening Balance:</label>
                    <input type="number" id="openingBalance" class="balance-input" placeholder="50000" value="50000" />
                    <span>₹</span>
                    <small style="color: #666; margin-left: 10px;">This will be overridden if Balance Sheet is provided</small>
                </div>
            </div>
            
            <button class="connect-btn" onclick="connectGoogleSheets()">🔗 Connect All Sheets</button>
            
            <div style="margin-top: 15px; text-align: center;">
                <button class="action-btn" onclick="hideSetupInstructions()" style="background: #6c757d;">❌ Close Setup</button>
            </div>
        </div>

        <!-- Welcome Message for Normal Users -->
        <div id="welcomeMessage" class="feature-highlight">
            <h4>🏠 Welcome to Siri Fortune Maintenance Dashboard</h4>
            <p style="margin-bottom: 15px; color: #555;">
                Your comprehensive financial management system with real-time data tracking and analysis.
            </p>
            <ul style="margin-left: 20px; color: #555; margin-bottom: 15px;">
                <li><strong>Real-time Monitoring:</strong> Track maintenance collections and expenses</li>
                <li><strong>Multi-month Analysis:</strong> View trends across different time periods</li>
                <li><strong>Smart Analytics:</strong> Interactive charts and detailed reports</li>
                <li><strong>Instant Search:</strong> Quick filtering and data exploration</li>
            </ul>
            <div style="text-align: center; margin-top: 15px;">
                <button class="action-btn" onclick="loadDemoData()" style="background: #27ae60;">📊 Load Demo Data</button>
                <button class="action-btn" onclick="showSetupInstructions()" style="background: #3498db; margin-left: 10px;">⚙️ Configure Data Source</button>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons" style="display: none;" id="actionButtons">
            <button class="action-btn" onclick="refreshData()">🔄 Refresh Data</button>
            <button class="action-btn export" onclick="exportData()">📥 Export Data</button>
            <button class="action-btn print" onclick="printReport()">🖨️ Print Report</button>
            <button class="action-btn" onclick="showSetupInstructions()">⚙️ Settings</button>
        </div>

        <!-- Navigation Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="overview">📊 Overview</button>
            <button class="tab" data-tab="payments">💳 Payments</button>
            <button class="tab" data-tab="expenses">💰 Expenses</button>
            <button class="tab" data-tab="financial">📈 Financial</button>
            <button class="tab" data-tab="defaulters">⚠️ Pending</button>
        </div>

        <!-- Overview Tab -->
        <div id="overview" class="tab-content active">
            <!-- Balance Summary Section -->
            <div class="balance-section">
                <h3 style="margin-bottom: 20px; color: #27ae60;" id="balanceSectionTitle">💰 Current Month Balance Summary</h3>
                <div class="balance-grid">
                    <div class="balance-item">
                        <label>Opening Balance:</label>
                        <span class="amount" id="displayOpeningBalance">₹50,000</span>
                    </div>
                    <div class="balance-item">
                        <label id="monthIncomeLabel">Month Income:</label>
                        <span class="amount" id="displayMonthIncome">₹0</span>
                    </div>
                    <div class="balance-item">
                        <label id="monthExpensesLabel">Month Expenses:</label>
                        <span class="expense-amount" id="displayMonthExpenses">₹0</span>
                    </div>
                    <div class="balance-item">
                        <label style="font-weight: bold; color: #27ae60;">Closing Balance:</label>
                        <span class="amount" style="font-weight: bold; font-size: 1.2rem;" id="displayClosingBalance">₹50,000</span>
                    </div>
                </div>
            </div>

            <!-- Key Metrics Grid -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value" id="avgExpense">₹0</div>
                    <div class="metric-label">Average Expense</div>
                </div>
            </div>
            
            <div class="chart-card">
                <div class="chart-title" id="expenseTableTitle">Expenses Breakdown</div>
                <table class="data-table" id="expensesTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Category</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Month</th>
                            <th>Vendor</th>
                        </tr>
                    </thead>
                    <tbody id="expensesTableBody">
                        <tr><td colspan="6" class="loading">Connect Google Sheets to see expense data</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Financial Tab -->
        <div id="financial" class="tab-content">
            <div class="charts-container">
                <div class="chart-card">
                    <div class="chart-title">Monthly Income vs Expenses</div>
                    <div class="chart-container">
                        <canvas id="monthlyFinancialChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-title" id="expenseChartTitle">Expense Breakdown by Category</div>
                    <div class="chart-container">
                        <canvas id="expenseChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-title" id="categoryTableTitle">Category-wise Expenses</div>
                <table class="data-table" id="categoryTable">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th id="categoryAmountHeader">Amount</th>
                            <th>Number of Entries</th>
                            <th>Average per Entry</th>
                            <th>% of Total</th>
                        </tr>
                    </thead>
                    <tbody id="categoryTableBody">
                        <tr><td colspan="5" class="loading">Connect Google Sheets to see category breakdown</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pending Payments Tab -->
        <div id="defaulters" class="tab-content">
            <div class="chart-card">
                <div class="chart-title" id="defaultersTitle">⚠️ Flats with Pending Payments</div>
                <div id="defaultersList">
                    <div class="loading">Connect Google Sheets to see pending payments</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let paymentData = {};
        let expenseData = [];
        let balanceData = {};
        let isConnected = false;
        let maintenanceSheetId = null;
        let expenseSheetId = null;
        let balanceSheetId = null;
        let openingBalance = 50000;
        let closingBalance = 50000;
        let availableMonths = [];
        let currentSelectedMonth = 'all';
        let financialChart, expenseChart, monthlyFinancialChart, balanceChart;

        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🏠 Dashboard initializing...');
            initializeTabs();
            initializeSearchFilters();
        });

        // Tab functionality
        function initializeTabs() {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetTab = tab.getAttribute('data-tab');
                    
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    tab.classList.add('active');
                    const targetContent = document.getElementById(targetTab);
                    if (targetContent) {
                        targetContent.classList.add('active');
                    }
                });
            });
        }

        // Search functionality
        function initializeSearchFilters() {
            const searchInput = document.getElementById('searchInput');
            const expenseSearchInput = document.getElementById('expenseSearchInput');

            if (searchInput) {
                searchInput.addEventListener('input', filterPaymentsTable);
            }

            if (expenseSearchInput) {
                expenseSearchInput.addEventListener('input', filterExpensesTable);
            }
        }

        // Show/hide setup instructions
        function showSetupInstructions() {
            const setupInstructions = document.getElementById('setupInstructions');
            const welcomeMessage = document.getElementById('welcomeMessage');
            
            if (setupInstructions) {
                setupInstructions.classList.add('show');
            }
            if (welcomeMessage) {
                welcomeMessage.style.display = 'none';
            }
        }

        function hideSetupInstructions() {
            const setupInstructions = document.getElementById('setupInstructions');
            const welcomeMessage = document.getElementById('welcomeMessage');
            
            if (setupInstructions) {
                setupInstructions.classList.remove('show');
            }
            if (welcomeMessage && !isConnected) {
                welcomeMessage.style.display = 'block';
            }
        }

        // Load demo data for normal users to see the interface
        function loadDemoData() {
            console.log('📊 Loading demo data...');
            
            // Hide welcome message and show action buttons
            const welcomeMessage = document.getElementById('welcomeMessage');
            const actionButtons = document.getElementById('actionButtons');
            
            if (welcomeMessage) {
                welcomeMessage.style.display = 'none';
            }
            if (actionButtons) {
                actionButtons.style.display = 'flex';
            }
            
            // Set demo data
            paymentData = {
                'A101': { Flat: 'A101', Mar2025: 2000, Apr2025: 2000, May2025: 0, Jun2025: 2000 },
                'A102': { Flat: 'A102', Mar2025: 2000, Apr2025: 0, May2025: 2000, Jun2025: 2000 },
                'A103': { Flat: 'A103', Mar2025: 0, Apr2025: 2000, May2025: 2000, Jun2025: 0 },
                'B201': { Flat: 'B201', Mar2025: 2000, Apr2025: 2000, May2025: 2000, Jun2025: 2000 },
                'B202': { Flat: 'B202', Mar2025: 0, Apr2025: 0, May2025: 2000, Jun2025: 2000 },
                'C301': { Flat: 'C301', Mar2025: 2000, Apr2025: 2000, May2025: 0, Jun2025: 0 }
            };
            
            expenseData = [
                { Date: '2025-03-01', Category: 'Maintenance', Description: 'Lift repair and servicing', Amount: 5000, Month: 'Mar2025', Vendor: 'Elevator Solutions Ltd' },
                { Date: '2025-03-15', Category: 'Utilities', Description: 'Electricity bill - common areas', Amount: 3000, Month: 'Mar2025', Vendor: 'State Electricity Board' },
                { Date: '2025-03-20', Category: 'Security', Description: 'Security guard salary', Amount: 8000, Month: 'Mar2025', Vendor: 'SecureMax Services' },
                { Date: '2025-04-01', Category: 'Maintenance', Description: 'Plumbing repairs - Block A', Amount: 2500, Month: 'Apr2025', Vendor: 'Quick Fix Plumbers' },
                { Date: '2025-04-10', Category: 'Cleaning', Description: 'Deep cleaning - common areas', Amount: 1500, Month: 'Apr2025', Vendor: 'CleanPro Services' },
                { Date: '2025-04-25', Category: 'Utilities', Description: 'Water tanker supply', Amount: 4000, Month: 'Apr2025', Vendor: 'AquaSupply Co' },
                { Date: '2025-05-05', Category: 'Landscaping', Description: 'Garden maintenance', Amount: 3000, Month: 'May2025', Vendor: 'Green Thumb Gardeners' },
                { Date: '2025-05-12', Category: 'Security', Description: 'CCTV system upgrade', Amount: 12000, Month: 'May2025', Vendor: 'TechSec Solutions' },
                { Date: '2025-06-01', Category: 'Maintenance', Description: 'Generator servicing', Amount: 2000, Month: 'Jun2025', Vendor: 'PowerGen Services' },
                { Date: '2025-06-15', Category: 'Utilities', Description: 'Internet and cable bills', Amount: 2500, Month: 'Jun2025', Vendor: 'DataNet Providers' }
            ];
            
            balanceData = {
                'Mar2025': { opening: 50000, closing: 48000, month: 'Mar2025' },
                'Apr2025': { opening: 48000, closing: 52000, month: 'Apr2025' },
                'May2025': { opening: 52000, closing: 49000, month: 'May2025' },
                'Jun2025': { opening: 49000, closing: 53500, month: 'Jun2025' }
            };
            
            // Set connection status
            isConnected = true;
            openingBalance = 50000;
            
            // Detect months and update dashboard
            detectAvailableMonths();
            updateDashboard();
            updateLastUpdated();
            updateConnectionStatus('connected', '✅ Demo data loaded successfully');
            
            console.log('✅ Demo data loaded successfully!');
        }

        // Error handling
        function showError(message) {
            const errorDiv = document.getElementById('errorMessages');
            if (errorDiv) {
                errorDiv.innerHTML = `<div class="error-message">❌ ${message}</div>`;
                errorDiv.style.display = 'block';
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 8000);
            }
            console.error('Dashboard Error:', message);
        }

        // Update connection status
        function updateConnectionStatus(status, message) {
            const statusElement = document.getElementById('connectionStatus');
            if (statusElement) {
                statusElement.className = `connection-status ${status}`;
                statusElement.textContent = message;
            }
        }

        // Connect to Google Sheets - MAIN FUNCTION
        async function connectGoogleSheets() {
            console.log('🔗 Connecting to Google Sheets...');
            try {
                updateConnectionStatus('connecting', '🔄 Connecting to Google Sheets...');
                
                const maintenanceInput = document.getElementById('maintenanceSheetId');
                const expenseInput = document.getElementById('expenseSheetId');
                const balanceInput = document.getElementById('balanceSheetId');
                const fallbackBalanceInput = document.getElementById('openingBalance');

                if (!maintenanceInput || !expenseInput || !fallbackBalanceInput) {
                    throw new Error('Input fields not found. Please refresh the page.');
                }

                maintenanceSheetId = maintenanceInput.value.trim();
                expenseSheetId = expenseInput.value.trim();
                balanceSheetId = balanceInput ? balanceInput.value.trim() : '';

                if (!maintenanceSheetId || !expenseSheetId) {
                    throw new Error('Please provide both Maintenance and Expense Sheet IDs');
                }

                console.log('Sheet IDs:', { maintenanceSheetId, expenseSheetId, balanceSheetId });

                const loadPromises = [
                    loadMaintenanceData(),
                    loadExpenseData()
                ];

                if (balanceSheetId) {
                    loadPromises.push(loadBalanceData());
                } else {
                    openingBalance = parseFloat(fallbackBalanceInput.value) || 50000;
                    console.log('Using fallback opening balance:', openingBalance);
                }

                await Promise.all(loadPromises);

                detectAvailableMonths();
                updateDashboard();
                
                const setupInstructions = document.getElementById('setupInstructions');
                const actionButtons = document.getElementById('actionButtons');
                const welcomeMessage = document.getElementById('welcomeMessage');
                
                if (setupInstructions) {
                    setupInstructions.classList.remove('show');
                }
                
                if (actionButtons) {
                    actionButtons.style.display = 'flex';
                }

                if (welcomeMessage) {
                    welcomeMessage.style.display = 'none';
                }
                
                updateConnectionStatus('connected', '✅ Connected to Google Sheets');
                updateLastUpdated();
                isConnected = true;

                console.log('✅ Connection successful!');

            } catch (error) {
                console.error('❌ Connection error:', error);
                showError(`Connection failed: ${error.message}`);
                updateConnectionStatus('disconnected', '❌ Connection failed');
            }
        }

        // Placeholder functions for the remaining functionality
        // (These would contain the complete implementation from the previous JavaScript code)
        
        function loadMaintenanceData() {
            // Implementation would go here
            return new Promise(resolve => {
                // Simulate data loading
                setTimeout(() => {
                    paymentData = {
                        'A101': { Flat: 'A101', Mar2025: 2000, Apr2025: 2000, May2025: 0 },
                        'A102': { Flat: 'A102', Mar2025: 2000, Apr2025: 0, May2025: 2000 },
                        'B201': { Flat: 'B201', Mar2025: 0, Apr2025: 2000, May2025: 2000 }
                    };
                    resolve();
                }, 1000);
            });
        }

        function loadExpenseData() {
            return new Promise(resolve => {
                setTimeout(() => {
                    expenseData = [
                        { Date: '2025-03-01', Category: 'Maintenance', Description: 'Lift repair', Amount: 5000, Month: 'Mar2025', Vendor: 'ABC Corp' },
                        { Date: '2025-03-15', Category: 'Utilities', Description: 'Electricity bill', Amount: 3000, Month: 'Mar2025', Vendor: 'Power Co' },
                        { Date: '2025-04-01', Category: 'Security', Description: 'Security service', Amount: 4000, Month: 'Apr2025', Vendor: 'SecureMax' }
                    ];
                    resolve();
                }, 800);
            });
        }

        function loadBalanceData() {
            return new Promise(resolve => {
                setTimeout(() => {
                    balanceData = {
                        'Mar2025': { opening: 50000, closing: 48000, month: 'Mar2025' },
                        'Apr2025': { opening: 48000, closing: 52000, month: 'Apr2025' },
                        'May2025': { opening: 52000, closing: 49000, month: 'May2025' }
                    };
                    resolve();
                }, 600);
            });
        }

        function detectAvailableMonths() {
            availableMonths = ['Mar2025', 'Apr2025', 'May2025'];
            updateMonthSelector();
            currentSelectedMonth = 'May2025';
            document.getElementById('monthSelector').value = currentSelectedMonth;
        }

        function updateMonthSelector() {
            const selector = document.getElementById('monthSelector');
            const availableSpan = document.getElementById('availableMonths');
            
            if (!selector || !availableSpan) return;
            
            selector.innerHTML = '<option value="all">All Months</option>';
            
            availableMonths.forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = month;
                selector.appendChild(option);
            });
            
            availableSpan.textContent = `Available: ${availableMonths.join(', ')}`;
        }

        function updateForSelectedMonth() {
            const selector = document.getElementById('monthSelector');
            if (selector) {
                currentSelectedMonth = selector.value;
                updateDashboard();
            }
        }

        function updateDashboard() {
            if (!isConnected) return;
            
            // Update all metrics and displays
            updateElement('totalFlats', Object.keys(paymentData).length);
            updateElement('currentCollection', '₹6,000');
            updateElement('currentExpenses', '₹3,000');
            updateElement('collectionRate', '75%');
            updateElement('pendingFlats', '1');
            
            // Update balance information
            updateElement('displayOpeningBalance', '₹50,000');
            updateElement('displayMonthIncome', '₹6,000');
            updateElement('displayMonthExpenses', '₹3,000');
            updateElement('displayClosingBalance', '₹53,000');
            
            updatePaymentsTable();
            updateExpensesTable();
            updateLabels();
        }

        function updatePaymentsTable() {
            const tableBody = document.getElementById('paymentsTableBody');
            if (!tableBody) return;
            
            let html = '';
            Object.keys(paymentData).forEach(flat => {
                const data = paymentData[flat];
                const amount = data[currentSelectedMonth] || 0;
                const status = amount > 0 ? 'Paid' : 'Pending';
                const statusClass = amount > 0 ? 'status-paid' : 'status-pending';
                
                html += `
                    <tr>
                        <td>${flat}</td>
                        <td class="amount">₹${amount.toLocaleString()}</td>
                        <td><span class="${statusClass}">${status}</span></td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
        }

        function updateExpensesTable() {
            const tableBody = document.getElementById('expensesTableBody');
            if (!tableBody) return;
            
            const filteredExpenses = currentSelectedMonth === 'all' 
                ? expenseData 
                : expenseData.filter(expense => expense.Month === currentSelectedMonth);
            
            let html = '';
            filteredExpenses.forEach(expense => {
                html += `
                    <tr>
                        <td>${expense.Date}</td>
                        <td>${expense.Category}</td>
                        <td>${expense.Description}</td>
                        <td class="expense-amount">₹${expense.Amount.toLocaleString()}</td>
                        <td>${expense.Month}</td>
                        <td>${expense.Vendor}</td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html || '<tr><td colspan="6" class="loading">No expenses found</td></tr>';
        }

        function updateLabels() {
            const monthText = currentSelectedMonth === 'all' ? 'All Months' : currentSelectedMonth;
            updateElement('balanceSectionTitle', `💰 ${monthText} Balance Summary`);
            updateElement('paymentsTableTitle', `Payment Status - ${monthText}`);
            updateElement('expenseTableTitle', `Expenses Breakdown - ${monthText}`);
        }

        function filterPaymentsTable() {
            const searchTerm = document.getElementById('searchInput')?.value?.toLowerCase() || '';
            const table = document.getElementById('paymentsTable');
            if (!table) return;

            const rows = table.getElementsByTagName('tr');
            for (let i = 1; i < rows.length; i++) {
                const flatCell = rows[i].getElementsByTagName('td')[0];
                if (flatCell) {
                    const flatNumber = flatCell.textContent.toLowerCase();
                    rows[i].style.display = flatNumber.includes(searchTerm) ? '' : 'none';
                }
            }
        }

        function filterExpensesTable() {
            const searchTerm = document.getElementById('expenseSearchInput')?.value?.toLowerCase() || '';
            const table = document.getElementById('expensesTable');
            if (!table) return;

            const rows = table.getElementsByTagName('tr');
            for (let i = 1; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                let matchFound = false;
                for (let j = 0; j < cells.length; j++) {
                    if (cells[j].textContent.toLowerCase().includes(searchTerm)) {
                        matchFound = true;
                        break;
                    }
                }
                rows[i].style.display = matchFound ? '' : 'none';
            }
        }

        function updateElement(id, value) {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
            }
        }

        function updateLastUpdated() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-IN', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            updateElement('lastUpdated', `Last updated: ${timeString}`);
        }

        function refreshData() {
            if (!isConnected) {
                showError('Please connect to Google Sheets first');
                return;
            }
            
            updateConnectionStatus('connecting', '🔄 Refreshing data...');
            setTimeout(() => {
                updateDashboard();
                updateLastUpdated();
                updateConnectionStatus('connected', '✅ Data refreshed successfully');
            }, 2000);
        }

        function exportData() {
            if (!isConnected) {
                showError('Please connect to Google Sheets first');
                return;
            }

            const data = {
                timestamp: new Date().toISOString(),
                selectedMonth: currentSelectedMonth,
                paymentData: paymentData,
                expenseData: expenseData,
                balanceData: balanceData
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `maintenance-dashboard-export-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function printReport() {
            window.print();
        }

        console.log('🏠 Siri Fortune Maintenance Dashboard UI loaded successfully!');
        console.log('💰 Features: Dynamic balance tracking, multi-month analysis, real-time updates');
    </script>
</body>
</html> class="metric-value" id="totalFlats">0</div>
                    <div class="metric-label">Total Flats</div>
                </div>
                <div class="metric-card success">
                    <div class="metric-value" id="currentCollection">₹0</div>
                    <div class="metric-label" id="currentCollectionLabel">Current Collections</div>
                </div>
                <div class="metric-card danger">
                    <div class="metric-value" id="currentExpenses">₹0</div>
                    <div class="metric-label" id="currentExpensesLabel">Current Expenses</div>
                </div>
                <div class="metric-card warning">
                    <div class="metric-value" id="collectionRate">0%</div>
                    <div class="metric-label">Collection Rate</div>
                </div>
                <div class="metric-card info">
                    <div class="metric-value" id="openingBalanceMetric">₹50,000</div>
                    <div class="metric-label">Opening Balance</div>
                </div>
                <div class="metric-card dark">
                    <div class="metric-value" id="closingBalanceMetric">₹50,000</div>
                    <div class="metric-label">Closing Balance</div>
                </div>
                <div class="metric-card purple">
                    <div class="metric-value" id="netBalance">₹0</div>
                    <div class="metric-label">Net Change</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="pendingFlats">0</div>
                    <div class="metric-label">Pending Flats</div>
                </div>
            </div>

            <!-- Financial Summary -->
            <div class="financial-summary">
                <h3 style="margin-bottom: 20px; color: #2c3e50;" id="financialSummaryTitle">📊 Current Month Financial Summary</h3>
                <div class="financial-row">
                    <span>💰 Opening Balance:</span>
                    <span class="amount" id="summaryOpeningBalance">₹50,000</span>
                </div>
                <div class="financial-row">
                    <span id="expectedIncomeLabel">Expected Income:</span>
                    <span class="amount" id="expectedIncomeAmount">₹0</span>
                </div>
                <div class="financial-row">
                    <span>Actual Collections:</span>
                    <span class="amount" id="actualCollections">₹0</span>
                </div>
                <div class="financial-row">
                    <span>Total Expenses:</span>
                    <span class="expense-amount" id="totalExpenses">₹0</span>
                </div>
                <div class="financial-row">
                    <span>💎 Closing Balance:</span>
                    <span class="amount" id="summaryClosingBalance">₹50,000</span>
                </div>
                <div class="financial-row">
                    <span>📈 Net Change:</span>
                    <span class="amount" id="netSurplus">₹0</span>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="charts-container">
                <div class="chart-card">
                    <div class="chart-title">Monthly Collection vs Expenses</div>
                    <div class="chart-container">
                        <canvas id="financialChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Balance Trend Over Time</div>
                    <div class="chart-container">
                        <canvas id="balanceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payments Tab -->
        <div id="payments" class="tab-content">
            <input type="text" class="search-box" placeholder="🔍 Search by flat number..." id="searchInput">
            
            <div class="chart-card">
                <div class="chart-title" id="paymentsTableTitle">Payment Status - All Months</div>
                <table class="data-table" id="paymentsTable">
                    <thead>
                        <tr id="paymentsTableHeader">
                            <th>Flat</th>
                            <th>Loading...</th>
                        </tr>
                    </thead>
                    <tbody id="paymentsTableBody">
                        <tr><td colspan="2" class="loading">Connect Google Sheets to see payment data</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Expenses Tab -->
        <div id="expenses" class="tab-content">
            <input type="text" class="search-box" placeholder="🔍 Search expenses..." id="expenseSearchInput">
            
            <div class="metrics-grid" style="margin-bottom: 30px;">
                <div class="metric-card danger">
                    <div class="metric-value" id="monthlyExpenseTotal">₹0</div>
                    <div class="metric-label" id="monthlyExpenseLabel">Total Expenses</div>
                </div>
                <div class="metric-card warning">
                    <div class="metric-value" id="expenseCount">0</div>
                    <div class="metric-label">Expense Entries</div>
                </div>
                <div class="metric-card">
                    <div
