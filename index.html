<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Siri Fortune Maintenance Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 15px;
        }

        .connection-status {
            background: rgba(255,255,255,0.1);
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-block;
            margin: 10px 5px;
            font-size: 0.9rem;
        }

        .connection-status.connected {
            background: rgba(46, 204, 113, 0.3);
        }

        .connection-status.disconnected {
            background: rgba(231, 76, 60, 0.3);
        }

        .connection-status.connecting {
            background: rgba(241, 196, 15, 0.3);
        }

        .refresh-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 15px;
            cursor: pointer;
            margin: 5px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .setup-instructions {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin: 20px;
            display: none;
        }

        .setup-instructions.show {
            display: block;
        }

        .setup-instructions h3 {
            color: #856404;
            margin-bottom: 10px;
        }

        .setup-instructions ol {
            color: #856404;
            margin-left: 20px;
        }

        .setup-instructions li {
            margin-bottom: 5px;
        }

        .url-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
        }

        .connect-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s ease;
        }

        .connect-btn:hover {
            background: #229954;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            overflow-x: auto;
        }

        .tab {
            padding: 15px 20px;
            background: #e9ecef;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            border-radius: 0;
            white-space: nowrap;
            min-width: 130px;
        }

        .tab.active {
            background: white;
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
        }

        .tab:hover:not(.active) {
            background: #dee2e6;
        }

        .tab-content {
            display: none;
            padding: 30px;
            min-height: 500px;
        }

        .tab-content.active {
            display: block;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 8px 15px rgba(52, 152, 219, 0.3);
            transition: transform 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-card.success {
            background: linear-gradient(135deg, #27ae60, #229954);
            box-shadow: 0 8px 15px rgba(39, 174, 96, 0.3);
        }

        .metric-card.warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            box-shadow: 0 8px 15px rgba(243, 156, 18, 0.3);
        }

        .metric-card.danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            box-shadow: 0 8px 15px rgba(231, 76, 60, 0.3);
        }

        .metric-card.purple {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            box-shadow: 0 8px 15px rgba(155, 89, 182, 0.3);
        }

        .metric-value {
            font-size: 2.2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2c3e50;
            text-align: center;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .data-table th {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .data-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .data-table tr:hover {
            background: #e3f2fd;
        }

        .status-paid {
            background: #d4edda;
            color: #155724;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .status-pending {
            background: #f8d7da;
            color: #721c24;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .amount {
            font-weight: 600;
            color: #2c3e50;
        }

        .expense-amount {
            font-weight: 600;
            color: #e74c3c;
        }

        .search-box {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 1rem;
            margin-bottom: 20px;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .search-box:focus {
            border-color: #3498db;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #7f8c8d;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .last-updated {
            position: absolute;
            top: 10px;
            right: 20px;
            background: rgba(255,255,255,0.1);
            color: white;
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 0.8rem;
        }

        .defaulter-card {
            background: #fff;
            border-left: 4px solid #e74c3c;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .flat-number {
            font-weight: bold;
            font-size: 1.1rem;
            color: #2c3e50;
        }

        .pending-info {
            color: #7f8c8d;
            margin-top: 5px;
        }

        .expense-category {
            display: inline-block;
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-right: 5px;
        }

        .financial-summary {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            border-left: 4px solid #3498db;
        }

        .financial-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .financial-row:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.1rem;
        }

        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .tab {
                padding: 12px 15px;
                font-size: 0.8rem;
                min-width: 100px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>üè† Siri Fortune Maintenance Dashboard</h1>
            <p>Complete Financial Management ‚Ä¢ Payments & Expenses Tracking</p>
            <div>
                <div id="connectionStatus" class="connection-status disconnected">
                    üì° Click "Connect" to link your Google Sheets
                </div>
                <button class="refresh-btn" onclick="refreshData()">üîÑ Refresh</button>
            </div>
            <div class="last-updated" id="lastUpdated">Never updated</div>
        </div>

        <!-- Setup Instructions -->
        <div id="setupInstructions" class="setup-instructions show">
            <h3>üîß Setup Required: Connect Your Google Sheets</h3>
            <ol>
                <li><strong>Sheet 1 (MaintenanceData):</strong> Flat payments (Flat, Mar2025, Apr2025, etc.)</li>
                <li><strong>Sheet 2 (ExpenseData):</strong> Monthly expenses (Date, Category, Description, Amount, etc.)</li>
                <li>Make both sheets public: "Anyone with link can view"</li>
                <li>Get Sheet IDs from URLs and paste below</li>
            </ol>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
                <div>
                    <label><strong>Maintenance Sheet ID:</strong></label>
                    <input type="text" id="maintenanceSheetId" class="url-input" placeholder="Maintenance sheet ID (gid=0)" />
                </div>
                <div>
                    <label><strong>Expense Sheet ID:</strong></label>
                    <input type="text" id="expenseSheetId" class="url-input" placeholder="Expense sheet ID (gid=123456)" />
                </div>
            </div>
            <button class="connect-btn" onclick="connectGoogleSheets()">Connect Both Sheets</button>
            <br><br>
            <small><strong>How to get Sheet IDs:</strong> From your Google Sheet URL: https://docs.google.com/spreadsheets/d/<strong>SHEET_ID</strong>/edit#gid=<strong>TAB_ID</strong></small>
        </div>

        <div class="tabs">
            <button class="tab active" data-tab="overview">üìä Overview</button>
            <button class="tab" data-tab="payments">üí≥ Payments</button>
            <button class="tab" data-tab="expenses">üí∞ Expenses</button>
            <button class="tab" data-tab="financial">üìà Financial</button>
            <button class="tab" data-tab="defaulters">‚ö†Ô∏è Pending</button>
            <button class="tab" data-tab="setup">‚öö Setup</button>
        </div>

        <div id="overview" class="tab-content active">
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value" id="totalFlats">0</div>
                    <div class="metric-label">Total Flats</div>
                </div>
                <div class="metric-card success">
                    <div class="metric-value" id="currentCollection">‚Çπ0</div>
                    <div class="metric-label">July Collections</div>
                </div>
                <div class="metric-card danger">
                    <div class="metric-value" id="currentExpenses">‚Çπ0</div>
                    <div class="metric-label">July Expenses</div>
                </div>
                <div class="metric-card warning">
                    <div class="metric-value" id="collectionRate">0%</div>
                    <div class="metric-label">Collection Rate</div>
                </div>
                <div class="metric-card purple">
                    <div class="metric-value" id="netBalance">‚Çπ0</div>
                    <div class="metric-label">Net Balance</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="pendingFlats">0</div>
                    <div class="metric-label">Pending Flats</div>
                </div>
            </div>

            <div class="financial-summary">
                <h3 style="margin-bottom: 20px; color: #2c3e50;">üìä July 2025 Financial Summary</h3>
                <div class="financial-row">
                    <span>Expected Income (37 √ó ‚Çπ2,500):</span>
                    <span class="amount">‚Çπ92,500</span>
                </div>
                <div class="financial-row">
                    <span>Actual Collections:</span>
                    <span class="amount" id="actualCollections">‚Çπ0</span>
                </div>
                <div class="financial-row">
                    <span>Total Expenses:</span>
                    <span class="expense-amount" id="totalExpenses">‚Çπ0</span>
                </div>
                <div class="financial-row">
                    <span>Net Surplus/(Deficit):</span>
                    <span class="amount" id="netSurplus">‚Çπ0</span>
                </div>
            </div>

            <div class="charts-container">
                <div class="chart-card">
                    <div class="chart-title">Monthly Collection vs Expenses</div>
                    <div class="chart-container">
                        <canvas id="financialChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Expense Breakdown by Category</div>
                    <div class="chart-container">
                        <canvas id="expenseChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div id="payments" class="tab-content">
            <input type="text" class="search-box" placeholder="üîç Search by flat number..." id="searchInput">
            
            <div class="chart-card">
                <div class="chart-title">Payment Status by Flat</div>
                <table class="data-table" id="paymentsTable">
                    <thead>
                        <tr>
                            <th>Flat</th>
                            <th>Mar 2025</th>
                            <th>Apr 2025</th>
                            <th>May 2025</th>
                            <th>Jun 2025</th>
                            <th>Jul 2025</th>
                            <th>Total Paid</th>
                        </tr>
                    </thead>
                    <tbody id="paymentsTableBody">
                        <tr><td colspan="7" class="loading">Connect Google Sheets to see payment data</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="expenses" class="tab-content">
            <input type="text" class="search-box" placeholder="üîç Search expenses..." id="expenseSearchInput">
            
            <div class="metrics-grid" style="margin-bottom: 30px;">
                <div class="metric-card danger">
                    <div class="metric-value" id="monthlyExpenseTotal">‚Çπ0</div>
                    <div class="metric-label">July Total Expenses</div>
                </div>
                <div class="metric-card warning">
                    <div class="metric-value" id="expenseCount">0</div>
                    <div class="metric-label">Expense Entries</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="avgExpense">‚Çπ0</div>
                    <div class="metric-label">Average Expense</div>
                </div>
            </div>
            
            <div class="chart-card">
                <div class="chart-title">Monthly Expenses Breakdown</div>
                <table class="data-table" id="expensesTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Category</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Vendor</th>
                            <th>Remarks</th>
                        </tr>
                    </thead>
                    <tbody id="expensesTableBody">
                        <tr><td colspan="6" class="loading">Connect Google Sheets to see expense data</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="financial" class="tab-content">
            <div class="charts-container">
                <div class="chart-card">
                    <div class="chart-title">Monthly Income vs Expenses</div>
                    <div class="chart-container">
                        <canvas id="monthlyFinancialChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Net Balance Trend</div>
                    <div class="chart-container">
                        <canvas id="balanceChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-title">Category-wise Monthly Expenses</div>
                <table class="data-table" id="categoryTable">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>July Amount</th>
                            <th>Number of Entries</th>
                            <th>Average per Entry</th>
                            <th>% of Total</th>
                        </tr>
                    </thead>
                    <tbody id="categoryTableBody">
                        <tr><td colspan="5" class="loading">Connect Google Sheets to see category breakdown</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="defaulters" class="tab-content">
            <div class="chart-card">
                <div class="chart-title">‚ö†Ô∏è Flats with Pending Payments</div>
                <div id="defaultersList">
                    <div class="loading">Connect Google Sheets to see pending payments</div>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-title">üìß Communication Templates</div>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 10px 0;">
                    <h4 style="color: #2c3e50; margin-bottom: 10px;">For Flats 201 & 505:</h4>
                    <p style="line-height: 1.6; color: #555;">
                        <strong>Subject:</strong> Maintenance Payment Confirmation Required - July 2025<br><br>
                        Dear residents of Flats 201 and 505,<br><br>
                        We kindly request confirmation of your maintenance payment for July 2025 (‚Çπ2,500 each).<br><br>
                        According to our records:<br>
                        ‚Ä¢ Flat 201: Payment status requires verification<br>
                        ‚Ä¢ Flat 505: Payment status requires verification<br><br>
                        Please confirm payment details or make payment if pending.<br><br>
                        Thank you for your cooperation.
                    </p>
                </div>
            </div>
        </div>

        <div id="setup" class="tab-content">
            <div class="chart-card">
                <div class="chart-title">üîó Complete Google Sheets Setup Guide</div>
                
                <h3>Step 1: Create MaintenanceData Sheet</h3>
                <p>Payment tracking sheet with this structure:</p>
                <table style="border-collapse: collapse; width: 100%; margin: 15px 0;">
                    <tr style="background: #f5f5f5;">
                        <th style="border: 1px solid #ddd; padding: 8px;">Flat</th>
                        <th style="border: 1px solid #ddd; padding: 8px;">Mar2025</th>
                        <th style="border: 1px solid #ddd; padding: 8px;">Apr2025</th>
                        <th style="border: 1px solid #ddd; padding: 8px;">May2025</th>
                        <th style="border: 1px solid #ddd; padding: 8px;">Jun2025</th>
                        <th style="border: 1px solid #ddd; padding: 8px;">Jul2025</th>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 8px;">101</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">2500</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">0</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">2500</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">2500</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">0</td>
                    </tr>
                </table>

                <h3>Step 2: Create ExpenseData Sheet</h3>
                <p>Expense tracking sheet with this structure:</p>
                <table style="border-collapse: collapse; width: 100%; margin: 15px 0;">
                    <tr style="background: #f5f5f5;">
                        <th style="border: 1px solid #ddd; padding: 8px;">Date</th>
                        <th style="border: 1px solid #ddd; padding: 8px;">Category</th>
                        <th style="border: 1px solid #ddd; padding: 8px;">Description</th>
                        <th style="border: 1px solid #ddd; padding: 8px;">Amount</th>
                        <th style="border: 1px solid #ddd; padding: 8px;">Month</th>
                        <th style="border: 1px solid #ddd; padding: 8px;">Vendor</th>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 8px;">2025-07-01</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">Security</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">Security Guard Salary</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">15000</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">Jul2025</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">Security Services</td>
                    </tr>
                </table>

                <h3>Step 3: Make Both Sheets Public</h3>
                <p>1. For each sheet: Click "Share" ‚Üí "Change to anyone with link"</p>
                <p>2. Set permission to "Viewer"</p>
                <p>3. Get Sheet ID from URL</p>

                <h3>Step 4: Get Sheet IDs</h3>
                <p><strong>MaintenanceData:</strong> Usually gid=0 (first sheet)</p>
                <p><strong>ExpenseData:</strong> Click expense tab, get gid from URL</p>

                <h3>Step 5: Connect to Dashboard</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
                    <div>
                        <input type="text" id="setupMaintenanceId" class="url-input" placeholder="Maintenance Sheet ID" />
                    </div>
                    <div>
                        <input type="text" id="setupExpenseId" class="url-input" placeholder="Expense Sheet ID" />
                    </div>
                </div>
                <button class="connect-btn" onclick="connectFromSetup()">Connect Both Sheets</button>

                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-top: 20px;">
                    <h4>üí° Pro Tips:</h4>
                    <ul>
                        <li><strong>Payments:</strong> Use "0" for unpaid, "2500" for paid</li>
                        <li><strong>Expenses:</strong> Use YYYY-MM-DD date format</li>
                        <li><strong>Categories:</strong> Security, Utilities, Maintenance, Cleaning, etc.</li>
                        <li><strong>Monthly Tracking:</strong> Use "Jul2025", "Aug2025" format</li>
                        <li><strong>Auto-refresh:</strong> Dashboard updates every 5 minutes</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let paymentData = {};
        let expenseData = [];
        let isConnected = false;
        let maintenanceSheetId = null;
        let expenseSheetId = null;
        let financialChart, expenseChart, monthlyFinancialChart, balanceChart;

        // Connect function
        function connectGoogleSheets() {
            const maintenanceInput = document.getElementById('maintenanceSheetId').value.trim();
            const expenseInput = document.getElementById('expenseSheetId').value.trim();
            
            if (!maintenanceInput || !expenseInput) {
                alert('Please enter both sheet IDs');
                return;
            }

            processConnection(maintenanceInput, expenseInput);
        }

        function connectFromSetup() {
            const maintenanceInput = document.getElementById('setupMaintenanceId').value.trim();
            const expenseInput = document.getElementById('setupExpenseId').value.trim();
            
            if (!maintenanceInput || !expenseInput) {
                alert('Please enter both sheet IDs');
                return;
            }

            processConnection(maintenanceInput, expenseInput);
        }

        function processConnection(maintenanceInput, expenseInput) {
            // Extract sheet IDs
            maintenanceSheetId = extractSheetId(maintenanceInput);
            expenseSheetId = extractSheetId(expenseInput);

            if (!maintenanceSheetId || !expenseSheetId) {
                alert('Invalid sheet IDs. Please check and try again.');
                return;
            }

            loadDataFromGoogleSheets();
        }

        function extractSheetId(input) {
            if (input.includes('docs.google.com')) {
                const match = input.match(/\/d\/([a-zA-Z0-9-_]+)/);
                return match ? match[1] : null;
            }
            return input;
        }

        async function loadDataFromGoogleSheets() {
            if (!maintenanceSheetId || !expenseSheetId) return;

            try {
                updateConnectionStatus('connecting', 'üîÑ Connecting to Google Sheets...');
                
                // Load maintenance data
                const maintenanceUrl = `https://docs.google.com/spreadsheets/d/${maintenanceSheetId}/export?format=csv&gid=0`;
                const maintenanceResponse = await fetch(maintenanceUrl);
                
                if (!maintenanceResponse.ok) {
                    throw new Error('Failed to fetch maintenance data. Check your maintenance sheet ID.');
                }
                
                const maintenanceCsv = await maintenanceResponse.text();
                
                // Load expense data
                const expenseUrl = `https://docs.google.com/spreadsheets/d/${maintenanceSheetId}/export?format=csv&gid=${expenseSheetId}`;
                const expenseResponse = await fetch(expenseUrl);
                
                const expenseCsv = await expenseResponse.text();
                
                // Parse maintenance data
                const maintenanceParsed = Papa.parse(maintenanceCsv, {
                    header: true,
                    skipEmptyLines: true,
                    dynamicTyping: true
                });

                // Parse expense data
                const expenseParsed = Papa.parse(expenseCsv, {
                    header: true,
                    skipEmptyLines: true,
                    dynamicTyping: true
                });

                // Process maintenance data
                paymentData = {};
                maintenanceParsed.data.forEach(row => {
                    if (row.Flat) {
                        const flatNum = row.Flat.toString();
                        paymentData[flatNum] = {
                            mar: parseFloat(row.Mar2025) || 0,
                            apr: parseFloat(row.Apr2025) || 0,
                            may: parseFloat(row.May2025) || 0,
                            jun: parseFloat(row.Jun2025) || 0,
                            jul: parseFloat(row.Jul2025) || 0
                        };
                    }
                });

                // Process expense data
                expenseData = expenseParsed.data.filter(row => row.Date && row.Amount);

                console.log('Loaded:', Object.keys(paymentData).length, 'flats,', expenseData.length, 'expenses');
                
                if (Object.keys(paymentData).length === 0) {
                    throw new Error('No payment data found. Check your maintenance sheet structure.');
                }

                updateConnectionStatus('connected', `‚úÖ Connected ‚Ä¢ ${Object.keys(paymentData).length} flats, ${expenseData.length} expenses`);
                isConnected = true;
                
                // Hide setup instructions
                document.getElementById('setupInstructions').classList.remove('show');
                
                // Update all components
                updateMetrics();
                populatePaymentsTable();
                populateExpensesTable();
                populateDefaultersList();
                populateCategoryTable();
                initializeCharts();
                
                // Update last updated time
                document.getElementById('lastUpdated').textContent = `Updated: ${new Date().toLocaleTimeString()}`;

            } catch (error) {
                console.error('Error loading Google Sheets data:', error);
                updateConnectionStatus('disconnected', `‚ùå Connection failed: ${error.message}`);
                
                // Show setup instructions again
                document.getElementById('setupInstructions').classList.add('show');
            }
        }

        function updateConnectionStatus(status, message) {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.className = `connection-status ${status}`;
            statusElement.textContent = message;
        }

        function refreshData() {
            if (maintenanceSheetId && expenseSheetId) {
                loadDataFromGoogleSheets();
            } else {
                alert('Please connect to Google Sheets first');
            }
        }

        function updateMetrics() {
            const totalFlats = Object.keys(paymentData).length;
            const currentMonthPayments = Object.values(paymentData).filter(flat => flat.jul > 0).length;
            const collectionRate = totalFlats > 0 ? Math.round((currentMonthPayments / totalFlats) * 100) : 0;
            const totalCollected = Object.values(paymentData).reduce((sum, flat) => sum + flat.jul, 0);
            
            // Calculate expenses for current month
            const currentMonthExpenses = expenseData
                .filter(expense => expense.Month === 'Jul2025')
                .reduce((sum, expense) => sum + (parseFloat(expense.Amount) || 0), 0);
            
            const netBalance = totalCollected - currentMonthExpenses;
            
            // Update metric cards
            document.getElementById('totalFlats').textContent = totalFlats;
            document.getElementById('currentCollection').textContent = `‚Çπ${totalCollected.toLocaleString()}`;
            document.getElementById('currentExpenses').textContent = `‚Çπ${currentMonthExpenses.toLocaleString()}`;
            document.getElementById('collectionRate').textContent = `${collectionRate}%`;
            document.getElementById('netBalance').textContent = `‚Çπ${netBalance.toLocaleString()}`;
            document.getElementById('pendingFlats').textContent = totalFlats - currentMonthPayments;
            
            // Update financial summary
            document.getElementById('actualCollections').textContent = `‚Çπ${totalCollected.toLocaleString()}`;
            document.getElementById('totalExpenses').textContent = `‚Çπ${currentMonthExpenses.toLocaleString()}`;
            document.getElementById('netSurplus').textContent = `‚Çπ${netBalance.toLocaleString()}`;
            
            // Update expense metrics
            const expenseCount = expenseData.filter(expense => expense.Month === 'Jul2025').length;
            const avgExpense = expenseCount > 0 ? Math.round(currentMonthExpenses / expenseCount) : 0;
            
            document.getElementById('monthlyExpenseTotal').textContent = `‚Çπ${currentMonthExpenses.toLocaleString()}`;
            document.getElementById('expenseCount').textContent = expenseCount;
            document.getElementById('avgExpense').textContent = `‚Çπ${avgExpense.toLocaleString()}`;
        }

        function populatePaymentsTable() {
            const tbody = document.getElementById('paymentsTableBody');
            if (!tbody || Object.keys(paymentData).length === 0) return;

            let html = '';
            
            Object.keys(paymentData).sort((a, b) => parseInt(a) - parseInt(b)).forEach(flat => {
                const data = paymentData[flat];
                const totalPaid = data.mar + data.apr + data.may + data.jun + data.jul;

                html += `
                    <tr>
                        <td><strong>Flat ${flat}</strong></td>
                        <td><span class="status-${data.mar > 0 ? 'paid' : 'pending'}">${data.mar > 0 ? 'Paid' : 'Pending'}</span></td>
                        <td><span class="status-${data.apr > 0 ? 'paid' : 'pending'}">${data.apr > 0 ? 'Paid' : 'Pending'}</span></td>
                        <td><span class="status-${data.may > 0 ? 'paid' : 'pending'}">${data.may > 0 ? 'Paid' : 'Pending'}</span></td>
                        <td><span class="status-${data.jun > 0 ? 'paid' : 'pending'}">${data.jun > 0 ? 'Paid' : 'Pending'}</span></td>
                        <td><span class="status-${data.jul > 0 ? 'paid' : 'pending'}">${data.jul > 0 ? 'Paid' : 'Pending'}</span></td>
                        <td class="amount">‚Çπ${totalPaid.toLocaleString()}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        function populateExpensesTable() {
            const tbody = document.getElementById('expensesTableBody');
            if (!tbody || expenseData.length === 0) return;

            let html = '';
            
            // Filter for current month and sort by date
            const currentMonthExpenses = expenseData
                .filter(expense => expense.Month === 'Jul2025')
                .sort((a, b) => new Date(b.Date) - new Date(a.Date));

            currentMonthExpenses.forEach(expense => {
                const date = new Date(expense.Date).toLocaleDateString('en-IN');
                const category = expense.Category || 'Other';
                
                html += `
                    <tr>
                        <td>${date}</td>
                        <td><span class="expense-category">${category}</span></td>
                        <td>${expense.Description || ''}</td>
                        <td class="expense-amount">‚Çπ${(parseFloat(expense.Amount) || 0).toLocaleString()}</td>
                        <td>${expense.Vendor || ''}</td>
                        <td>${expense.Remarks || ''}</td>
                    </tr>
                `;
            });

            if (html === '') {
                html = '<tr><td colspan="6" class="loading">No expenses found for July 2025</td></tr>';
            }

            tbody.innerHTML = html;
        }

        function populateDefaultersList() {
            const container = document.getElementById('defaultersList');
            if (!container || Object.keys(paymentData).length === 0) return;

            let html = '';
            let defaultersFound = false;

            Object.keys(paymentData).forEach(flat => {
                const data = paymentData[flat];
                let pendingMonths = [];
                
                if (data.mar === 0) pendingMonths.push('March');
                if (data.apr === 0) pendingMonths.push('April');
                if (data.may === 0) pendingMonths.push('May');
                if (data.jun === 0) pendingMonths.push('June');
                if (data.jul === 0) pendingMonths.push('July');

                if (pendingMonths.length > 0) {
                    defaultersFound = true;
                    const pendingAmount = pendingMonths.length * 2500;
                    html += `
                        <div class="defaulter-card">
                            <div class="flat-number">Flat ${flat}</div>
                            <div class="pending-info">
                                Pending: ${pendingMonths.join(', ')} | Amount: ‚Çπ${pendingAmount.toLocaleString()}
                            </div>
                        </div>
                    `;
                }
            });

            if (!defaultersFound) {
                html = '<div style="text-align: center; padding: 40px; color: #27ae60;"><h3>üéâ No pending payments!</h3><p>All flats are up to date with their maintenance payments.</p></div>';
            }

            container.innerHTML = html;
        }

        function populateCategoryTable() {
            const tbody = document.getElementById('categoryTableBody');
            if (!tbody || expenseData.length === 0) return;

            // Group expenses by category for current month
            const currentMonthExpenses = expenseData.filter(expense => expense.Month === 'Jul2025');
            const categoryTotals = {};
            
            currentMonthExpenses.forEach(expense => {
                const category = expense.Category || 'Other';
                const amount = parseFloat(expense.Amount) || 0;
                
                if (!categoryTotals[category]) {
                    categoryTotals[category] = { total: 0, count: 0 };
                }
                categoryTotals[category].total += amount;
                categoryTotals[category].count += 1;
            });

            const totalExpenses = Object.values(categoryTotals).reduce((sum, cat) => sum + cat.total, 0);
            let html = '';

            Object.entries(categoryTotals)
                .sort((a, b) => b[1].total - a[1].total)
                .forEach(([category, data]) => {
                    const percentage = totalExpenses > 0 ? ((data.total / totalExpenses) * 100).toFixed(1) : 0;
                    const average = data.count > 0 ? Math.round(data.total / data.count) : 0;
                    
                    html += `
                        <tr>
                            <td><span class="expense-category">${category}</span></td>
                            <td class="expense-amount">‚Çπ${data.total.toLocaleString()}</td>
                            <td>${data.count}</td>
                            <td class="amount">‚Çπ${average.toLocaleString()}</td>
                            <td>${percentage}%</td>
                        </tr>
                    `;
                });

            if (html === '') {
                html = '<tr><td colspan="5" class="loading">No expense categories found</td></tr>';
            }

            tbody.innerHTML = html;
        }

        function initializeCharts() {
            if (!Object.keys(paymentData).length) return;

            // Destroy existing charts
            if (financialChart) financialChart.destroy();
            if (expenseChart) expenseChart.destroy();
            if (monthlyFinancialChart) monthlyFinancialChart.destroy();
            if (balanceChart) balanceChart.destroy();

            // Calculate monthly data
            const months = ['March', 'April', 'May', 'June', 'July'];
            const monthKeys = ['mar', 'apr', 'may', 'jun', 'jul'];
            const monthlyCollections = monthKeys.map(key => 
                Object.values(paymentData).reduce((sum, flat) => sum + flat[key], 0)
            );

            // Calculate monthly expenses
            const monthlyExpenses = ['Mar2025', 'Apr2025', 'May2025', 'Jun2025', 'Jul2025'].map(month => 
                expenseData
                    .filter(expense => expense.Month === month)
                    .reduce((sum, expense) => sum + (parseFloat(expense.Amount) || 0), 0)
            );

            // Financial comparison chart
            const financialCtx = document.getElementById('financialChart');
            if (financialCtx) {
                financialChart = new Chart(financialCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'Collections',
                            data: monthlyCollections,
                            backgroundColor: '#27ae60',
                            borderRadius: 5
                        }, {
                            label: 'Expenses',
                            data: monthlyExpenses,
                            backgroundColor: '#e74c3c',
                            borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '‚Çπ' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Expense breakdown chart
            const expenseCtx = document.getElementById('expenseChart');
            if (expenseCtx) {
                const currentMonthExpenses = expenseData.filter(expense => expense.Month === 'Jul2025');
                const categoryTotals = {};
                
                currentMonthExpenses.forEach(expense => {
                    const category = expense.Category || 'Other';
                    const amount = parseFloat(expense.Amount) || 0;
                    categoryTotals[category] = (categoryTotals[category] || 0) + amount;
                });

                const labels = Object.keys(categoryTotals);
                const data = Object.values(categoryTotals);
                const colors = ['#3498db', '#e74c3c', '#f39c12', '#27ae60', '#9b59b6', '#1abc9c', '#34495e'];

                expenseChart = new Chart(expenseCtx.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors.slice(0, labels.length),
                            borderWidth: 0,
                            hoverOffset: 10
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    usePointStyle: true
                                }
                            }
                        }
                    }
                });
            }

            // Monthly financial comparison
            const monthlyFinancialCtx = document.getElementById('monthlyFinancialChart');
            if (monthlyFinancialCtx) {
                monthlyFinancialChart = new Chart(monthlyFinancialCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'Income',
                            data: monthlyCollections,
                            borderColor: '#27ae60',
                            backgroundColor: 'rgba(39, 174, 96, 0.1)',
                            fill: false,
                            tension: 0.4
                        }, {
                            label: 'Expenses',
                            data: monthlyExpenses,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            fill: false,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '‚Çπ' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Net balance trend
            const balanceCtx = document.getElementById('balanceChart');
            if (balanceCtx) {
                const netBalances = monthlyCollections.map((income, index) => income - monthlyExpenses[index]);
                
                balanceChart = new Chart(balanceCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'Net Balance',
                            data: netBalances,
                            backgroundColor: netBalances.map(balance => balance >= 0 ? '#27ae60' : '#e74c3c'),
                            borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                ticks: {
                                    callback: function(value) {
                                        return '‚Çπ' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        function filterPayments(searchTerm) {
            const table = document.getElementById('paymentsTable');
            if (!table) return;

            const rows = table.getElementsByTagName('tr');
            for (let i = 1; i < rows.length; i++) {
                const flatCell = rows[i].getElementsByTagName('td')[0];
                if (flatCell) {
                    const flatNumber = flatCell.textContent || flatCell.innerText;
                    if (flatNumber.toLowerCase().indexOf(searchTerm.toLowerCase()) > -1) {
                        rows[i].style.display = '';
                    } else {
                        rows[i].style.display = 'none';
                    }
                }
            }
        }

        function filterExpenses(searchTerm) {
            const table = document.getElementById('expensesTable');
            if (!table) return;

            const rows = table.getElementsByTagName('tr');
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                const text = row.textContent.toLowerCase();
                if (text.indexOf(searchTerm.toLowerCase()) > -1) {
                    rows[i].style.display = '';
                } else {
                    rows[i].style.display = 'none';
                }
            }
        }

        function showTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab content
            const selectedContent = document.getElementById(tabName);
            if (selectedContent) {
                selectedContent.classList.add('active');
            }
            
            // Add active class to clicked tab
            const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard initializing...');
            
            // Add event listeners for tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    showTab(tabName);
                });
            });

            // Add search functionality
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('keyup', function() {
                    filterPayments(this.value);
                });
            }

            const expenseSearchInput = document.getElementById('expenseSearchInput');
            if (expenseSearchInput) {
                expenseSearchInput.addEventListener('keyup', function() {
                    filterExpenses(this.value);
                });
            }

            // Auto-refresh every 5 minutes if connected
            setInterval(() => {
                if (isConnected && maintenanceSheetId && expenseSheetId) {
                    console.log('Auto-refreshing data...');
                    loadDataFromGoogleSheets();
                }
            }, 5 * 60 * 1000);

            console.log('Dashboard initialized successfully');
        });

        // Handle window resize for charts
        window.addEventListener('resize', function() {
            if (financialChart) financialChart.destroy();
            if (expenseChart) expenseChart.destroy();
            if (monthlyFinancialChart) monthlyFinancialChart.destroy();
            if (balanceChart) balanceChart.destroy();
            setTimeout(initializeCharts, 100);
        });
    </script>
</body>
</html>
